<meta charset="utf-8"/>
<!DOCTYPE html>
<html>
  <head>
    <title>CS490 - Instructor Landing Page</title>
    <link href="styles.css" type="text/css" rel="stylesheet" /> 
  </head>
  <body>
    <form id="index">
        <header>
            <nav>
              <h1>This is the INSTRUCTOR landing page.</h1>
              <ul>
              <li><button id="button1" type="button">Create Question</button></li>
              <li><button id="button2" type="button">Create Exam</button></li>
              <li><button id="button3" type="button">Get Exam</button></li>
              <li><button id="button4" type="button">Logout</button></li>
              </ul>
            </nav>
          </header>
      <div class="split left">
      <br>
        <fieldset><p id="work_area"></p></fieldset><br><br>
        <fieldset><p id="response_area"></p></fieldset><br><br>
      </div>
    </form>

    <div class="split right">
      <h3>Question Bank:</h3>
      <nav>
      <h3 class="sort_bar">Difficulty: <select id="sort_diff" name="sort_diff">
        <option value="all"></option>
        <option value="easy">easy</option>
        <option value="medium">medium</option>
        <option value="hard">hard</option>
      </select>
      Topic: <select id="sort_topic" name="sort_topic">
        <option value="all"></option>
        <option value="if">if</option>
        <option value="loop">loop</option>
        <option value="arithmatic">arithmatic</option>
      </select>
      Keyword: <input type="text" id="sort_keyword" name="sort_keyword">
      <button id="button5" type="button">Sort</button></h3>
      <p id="insertQuestion"></p>
      </nav>
    </div>
  </body>
  <script type="text/javascript">
  
//EL---------------------Event Listeners----------------------------------
     
    var button1 = document.getElementById("button1");
    button1.addEventListener("click", createQuestion);

    var button2 = document.getElementById("button2");
    button2.addEventListener("click", createExam);
     
    var button3 = document.getElementById("button3");
    button3.addEventListener("click", showExams);
    
    var button4 = document.getElementById("button4");
    button4.addEventListener("click", logout);
    
    var button5 = document.getElementById("button5");
    button5.addEventListener("click", showQuestions);
    
//GV---------------------Global Variables----------------------------------
    
    var message = "", gexid = "", gqid = [];
    
//LF---------------------Logout Function----------------------------------
    
    function logout(){
      console.log("Logout Button Click");
      window.location.href = "index.html";
    }
    
//CBF---------------------Call Back Function----------------------------------
    
function setResp(jsonData){
      if(jsonData.response){
        document.getElementById("response_area").innerHTML = jsonData.response;
      }
      else{
        document.getElementById("response_area").innerHTML = jsonData;
      }
    }
//CEF--------------------Create Exam Function----------------------------------
    
function createExam(){
  document.getElementById("response_area").innerHTML = '';
  document.getElementById("work_area").innerHTML = '\
    <h3>Create Exam:</h3>\
    <label>Exam Name:</label>\
    <input type="text" name="examName">\
    <p>Total Points: <label id="totalPoints"></label></p>\
    <button id="button6" type="button">Submit</button>';
      
      var button6 = document.getElementById("button6");
      button6.addEventListener("click", function() {message = "CreateExam"; submit(setResp);});
    };
    
//CQF--------------------Create Question Function-----------------------------
    
    function createQuestion(){
      console.log("Create Question");
      document.getElementById("response_area").innerHTML = '';
      document.getElementById("work_area").innerHTML = '\
        <h3>Create a Question:</h3> <label>Function Name:</label><input type="text" name="question">\
        <br><label>Description:</label><br><textarea name="description" rows="10" cols="58"></textarea>\
        <br><label>Difficulty:</label><select name="difficulty">\
          <option value="easy">easy</option>\
          <option value="medium">medium</option>\
          <option value="hard">hard</option>\
        </select><label>Topic:</label><select name="topic">\
          <option value="if">if</option>\
          <option value="loop">loop</option>\
          <option value="arithmetic">arithmetic</option>\
        </select><br><label>Test Case 1:</label><input type="text" name="tcs1">\
        <label>Test Case 1 Result:</label><input type="text" name="tcsr1"><br>\
        <label>Test Case 2:</label><input type="text" name="tcs2">\
        <label>Test Case 2 Result:</label><input type="text" name="tcsr2"><br>\
        <button id="button7" type="button">Submit</button>';
      
      var button7 = document.getElementById("button7");
      button7.addEventListener("click", function() {message = "CreateQuestion"; submit(updateQB);});
    };
    
    function updateQB(jsonData){
      console.log("submit");
      document.getElementById("response_area").innerHTML = jsonData.response;
      showQuestions();
    }
    
//SBE--------------------Show / Build Exams----------------------------------
    
    function showExams(){
      message = "GetExam";
      submit(getExam);
    }
    
    function getExam(jsonData){
      var i, released = "", review = "", pending = "", examid = "", status = "";
      for(i=0; i<jsonData.length; i++){
        examid = jsonData[i].examName;
        status = jsonData[i].releaseStatus;
        if(status == "2"){
          released += '<br>Released: ' + examid;
        } else if(status == "0"){
          pending += '<br>Pending Student Action: ' + examid;
        } else{
          review += '<br>Needs Instructor Review: '+ examid + ' <button  type="button" onclick="previewExam(\'' + examid + '\')"> Open</button> ';
        }
      }
      document.getElementById("response_area").innerHTML = '';
      document.getElementById("work_area").innerHTML = '<h3>Available Exams:</h3>' + review + released + pending;
    }
    
    function previewExam(examid){
      gexid = examid;
      message = "StudentViewExam";
      submit(buildExam);
    }
    
    function buildExam(jsonData){
      var i, qnum = 1, agdata = "", exdata="", fun = "", rtn = "", tp = "", desc = "", cd = "", grd = "", ptt = "", comm = "", tgd = "";
      gqid = [];
      for(i=0; i<jsonData.length; i++){
        
        qid = jsonData[i].questionID;
        fn2 = jsonData[i].question;
        tp = jsonData[i].topic;
        desc = jsonData[i].description;
        cd = jsonData[i].code;
        grd = jsonData[i].grade;
        ptt = jsonData[i].points;
        comm = jsonData[i].comments;
        fun = jsonData[i].error1;
        rtn = jsonData[i].error2;
        gqid.push(qid);

        agdata = '<table><tr><th>Test Cases</th></tr>';
        
        if(rtn != "0"){
          agdata += '<tr><td>No return statement: -\
                     <input id=\'rtn' + i + '\' value=\'' + rtn + '\' oninput="totalCalc(' + i + ', ' + ptt + ')">\
                     </td></tr>';
        }
        if(fun != "0"){
          agdata += '<tr><td>Incorrect function name: -\
                     <input id=\'fun' + i + '\' value=\'' + fun + '\' oninput="totalCalc(' + i + ', ' + ptt + ')">\
                     </td></tr>';
        }
        
        agdata += '</table>';
        exdata += '<h3>Question ' + qnum + ':</h3><b>Function Name: </b>' + fn2 + '<b>\
                   Topic: </b>' + tp + '<br><br>' + desc + '<h4>Answer:</h4>\
                   <textarea rows="5" cols="30" disabled="true">' + cd + '</textarea><h4>\
                   Auto Grader Results:</h4>' + (agdata == "<table><tr><th>\
                   Test Case</th></tr></table>" ? "No Reductions" : agdata) + '<br><br>\
                   Grade: <input type="text" name="grd[]"> / ' + ptt + '<h4>Add Comments:</h4>\
                   <textarea name="comm[]" rows="5" cols="30" value=' + comm + '></textarea>';
        qnum++;
      }
      document.getElementById("response_area").innerHTML = '<h3>' + gexid + ' Exam:<h3>' + exdata + '<br><br><button id="button8" type="button">Release Exam</button>';
      for(i=0; i<jsonData.length; i++){
        totalCalc(i, ptt);
      }
      var button8 = document.getElementById("button8");
      button8.addEventListener("click", releaseExam);
    }
//CALC-------------------Calculate Question Worth - Auto Grade Deducations------
    function totalCalc(i, ptt){
      var total = ptt;

      if(document.getElementById('rtn' + i)){total -= document.getElementById('rtn' + i).value;}
      if(document.getElementById('fun' + i)){total -= document.getElementById('fun' + i).value;} 
      document.getElementsByName('grd[]')[i].value = total;
    }

    function totalPoints(){
      var i, points = 0;
      var pt = document.getElementsByName('pts[]');

      for(i=0; i<pt.length;i++){
        points += Number(pt[i].value);
      }
      document.getElementById("totalPoints").innerHTML = points;
    }
//REL--------------------Release Exam-------------------------------------------   
    function releaseExam(){
      console.log("Release Exam");
      message = "ReleaseExam";
      submit(setResp);
    };
    
//QBF--------------------Question Bank Function----------------------------------
    
    function showQuestions(){
      message = "GetQuestions";
      submit(buildQB);
    };
    
    function buildQB(jsonData){
      var i, qbdata = "", qid = "", desc = "", qtype = "", fname = "", tc1 = "", tc2 = "",
          tcr1 = "", tcr2 = "";
      var sort_topic = document.getElementById("sort_topic").value;
      var sort_diff = document.getElementById("sort_diff").value;
      var sort_keyword = document.getElementById("sort_keyword").value;

      for(i=0; i<jsonData.length; i++){ 
        qid = jsonData[i].questionID;
        fname = jsonData[i].question;
        desc = jsonData[i].description;
        qtype = jsonData[i].topic;
        diff = jsonData[i].difficulty;
        tc1 = jsonData[i].testCase1;
        tc2 = jsonData[i].testCase2;
        tcr1 = jsonData[i].testCaseResult1;
        tcr2 = jsonData[i].testCaseResult2;
        
        if((sort_diff == diff || sort_diff == "all") && (qtype.includes(sort_topic) || sort_topic == "all") 
        && (desc.includes(sort_keyword) || sort_keyword == "")){
           qbdata += '<fieldset id="question' + i + '"><button type="button" onclick="addQuestion(question' + i + ')">\
           Add</button><br><b>Function Name: </b>' + fname + '<b> Topic: </b>' + qtype + '<br><b>\
           Test Case 1: </b>' + tc1 + ' || <b> Test Case 1 Output: </b>' + tcr1 + '<input type="text"\
           name="qid[]" value=' + qid + ' hidden><br><b> Test Case 2: </b>' + tc2 + ' || <b>\
           Test Case 2 Output: </b>' + tcr2 + '<br><b>Points: </b><input type="number" name="pts[]"\
           oninput="totalPoints()"><br>' + '<b>Difficulty: </b>' + diff + '<br><b>Description: </b>' + desc + '<br><br></fieldset>';
        }
      }
      document.getElementById("insertQuestion").innerHTML = qbdata;
    }
    
    function addQuestion(field){
      field.removeChild(field.childNodes[0]);
      document.getElementById("work_area").appendChild(field);
    }    
        
//ADF--------------------AJAX Driver Function----------------------------------
    
    function submit(cFunction){
      var formData = new FormData(document.querySelector("form"));
      console.log(message);
      formData.append("message", message);
      
      if(message == "CreateExam"){
        var questionID = [], points = [];
        var qid = document.getElementById("index").elements.namedItem("qid[]");
        var pts = document.getElementById("index").elements.namedItem("pts[]");

        for(var i=0; i<qid.length; i++){
          questionID.push(qid[i].value);
          points.push(pts[i].value);
        }
        formData.append("questionID", questionID);
        formData.append("points", points);
      }
      
      if(message == "ReleaseExam"){
        var grade = [], comments = [], rtn = [], fun = [];
        var grd = document.getElementsByName("grd[]");
        var comm = document.getElementsByName("comm[]");

        for(var i=0; i<grd.length; i++){
          if(document.getElementById('rtn' + i)){rtn.push(document.getElementById('rtn' + i).value);} else{rtn.push(0);}
          if(document.getElementById('fun' + i)){fun.push(document.getElementById('fun' + i).value);} else{fun.push(0);}

          grade.push(grd[i].value);
          comments.push(comm[i].value);
        }

        formData.append("return", rtn);
        formData.append("question", fun);
        formData.append("questionID", gqid);
        formData.append("examId", gexid);
        formData.append("grade", grade);
        formData.append("comments", comments);
      }

      if(message == "StudentViewExam"){
        formData.append("examId", gexid);
      }
      
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if(this.readyState == 4 && this.status == 200) {
          console.log(this.responseText);
          jsonData = JSON.parse(this.responseText);
          console.log(jsonData);
          cFunction(jsonData);
        }
      };
      
      xhr.open("POST", "curlhandler.php", true);
      xhr.send(formData);
      
    }
    
    showQuestions();
  </script>
</html>